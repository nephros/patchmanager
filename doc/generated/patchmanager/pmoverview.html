<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- index.qdoc -->
  <title>Patchmanager Overview | Patchmanager Documentation</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content">
  </div>
  <div class="breadcrumb">
    <ul>
      <!--  Breadcrumbs go here -->
<li>https://sailfishos-patches.github.io/patchmanager</li>
<li><a href="index.html">Patchmanager Documentation</a></li>
<li>Patchmanager Overview</li>
    </ul>
  </div>
</div>
<div class="content">
  <link rel="next" href="pmservices.html" />
<p class="naviNextPrevious headerNavi">
<a class="nextPage" href="pmservices.html">Patchmanager Services</a>
</p><p/>
<div class="sidebar">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#operation-flow">Operation Flow</a></li>
<li class="level2"><a href="#1-a-patch-is-activated">1. A Patch is &quot;activated&quot;</a></li>
<li class="level2"><a href="#2-a-patched-application-is-launched">2. A patched application is launched.</a></li>
<li class="level2"><a href="#3-the-preload-library">3. The Preload Library:</a></li>
</ul>
</div>
<div class="sidebar-content" id="sidebar-content"></div></div>
<h1 class="title">Patchmanager Overview</h1>
<span class="subtitle"></span>
<!-- $$$pmoverview.html-description -->
<div class="descr"> <a name="details"></a>
<p>So the current mode of operation of Patchmanager is something like this:</p>
<a name="operation-flow"></a>
<h2 id="operation-flow">Operation Flow</h2>
<a name="1-a-patch-is-activated"></a>
<h3 >1. A Patch is &quot;activated&quot;</h3>
<p>When a user activates a patch via the App, a signal is sent to the daemon.</p>
<p>When activated, for each file the patch manipulates, a copy of the original file is put into a cache directory in <code>/tmp</code>, and the changes are applied there instead of on the original file.</p>
<p>If there are paths or files involved in the patch which do not exist yet in the filesystem, they will be created in the cache directory, and a symbolic link pointing to them is placed in the original filesystem.</p>
<a name="2-a-patched-application-is-launched"></a>
<h3 >2. A patched application is launched.</h3>
<p>Through library preloading, the <code>libpreloadpatchmanager.so</code> library is injected into the launching binary.</p>
<a name="3-the-preload-library"></a>
<h3 >3. The Preload Library:</h3>
<ul>
<li>Intercepts calls to <a href="https://www.man7.org/linux/man-pages/man2/open.2.html"><code>open()</code> (or <code>open64()</code>)</a>,</li>
<li>analyzes which files the call was meant to open</li>
<li>asks the Patchmanager daemon (via UNIX Socket) whether it knows of a patched version.</li>
</ul>
<p>If yes, the daemon will return a path to its cache directory, and the library redirects the call to that file instead of the original. Otherwise, the <code>open()</code> is executed on the original file.</p>
<p>Certain paths are blacklisted for these operations to reduce the risk of critical services, or PM itself, choking on these redirections.</p>
<p><b>Warning:</b> After activating a Patch , the daemon may also inform the UI that some apps or services need restart. The UI client is expected to issue the command to restart these soon. As long as the corresponding processes are not restarted, the effect of the applied patch will not show, or may only show partially, depending on the &quot;patch history&quot; of the respective process.</p>
<p><b>Note: </b>Due to the nature of the interaction between the daemon and the library, applications which are executed ..&#x2e;</p><ul>
<li>without respecting <code>/etc/ld.so.preload</code> (e.g&#x2e; Android binaries in the base system)</li>
<li>before the daemon has started and initialised</li>
</ul>
<p>... will obviously not see patched file contents. Patch authors are advised to use other methods (e.g&#x2e; proper RPM packages, or e.g&#x2e; systemd services to manipulate files in these cases, and refrain from using Patches to do that.)</p>
<p><i>to be continued..&#x2e;</i></p>
</div>
<!-- @@@pmoverview.html -->
<p class="naviNextPrevious footerNavi">
<a class="nextPage" href="pmservices.html">Patchmanager Services</a>
</p>
<div align='center'><hr/> <p><small>Patchmanager Documentation
Copyright (c) 2023 Patchmanager for SailfishOS contributors.
This document may be used under the terms of the  <a href='https://spdx.org/licenses/CC-BY-SA-4.0.html'> Creative Commons Attribution Share Alike 4.0 International</a>  License.</small></p> <p/></div></body>
</html>
